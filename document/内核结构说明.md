# 内核结构说明

## 各模块简述

* UART 负责内核输入输出
* PLIC 管理设备中断
* CPU 处理一部分硬件操控
* Memory 内存管理
* task 任务系统
* libs 内核用到的一些工具函数，如字符转换等
* interrupt 中断处理、系统调用等
* interact 处理控制台的交互，有一个简陋的 shell 用于测试功能
* virtio 设备管理
* graphic 一些图形的结构，桌面系统的图形显示功能基于此
* desktop 一个简单的桌面交互工具

## 初始化流程

请结合 `src/main.rs` 中的 `kernel_init` 函数

* 初始化 uart
* 设置 mscratch
* 初始化内存管理
* 在 PLIC 中设置设备阈值
* 初始化任务系统（其实里面是空的，不需要初始化）
* 设置输入缓冲，这主要用于存储设备输入 
* 扫描并添加设备
* 进入主线程

其中，进入主线程后还有一段初始化的代码

* 开启时间中断，默认 timer 间隔为 15 毫秒（这意味着本系统的 sleep 功能只能精确到 15 毫秒）
* 初始化文件系统
* fork 第一个分支去执行 shell
* branch 出一个分支去循环输出
* 如果支持图形输出，fork 一个桌面

## 各模块默认实现说明（持续更新）

### 中断

太素的中断在机器模式下处理。每个核心的 mscratch 寄存器保存一个存放环境的地址

### 内存管理

页面管理默认使用简单的最先适配方法，选取最前面的足够大的连续页面，所以碎片可能较多。分为内核页面、用户页面两块区域。

堆内存在页面管理基础上，用一个类似 SLAB 的链式内存池

### 任务系统

分为线程、进程。进程保管程序的堆内存、程序区域、satp 等全局信息。线程保存栈、寄存器等执行环境